name: Builder

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - master
  workflow_dispatch:

env:
  NRF_TOOLCHAIN_VERSION: v2.7.0
  NRF_SDK_VERSION: v2.7.0

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Install Dependencies + West + NRF Util
        run: |
          sudo apt update
          sudo apt install --no-install-recommends \
            curl \
            git \
            python3 python3-pip \

          pip3 install --break-system-packages west

          curl https://files.nordicsemi.com/artifactory/swtools/external/nrfutil/executables/x86_64-unknown-linux-gnu/nrfutil -o /usr/local/bin/nrfutil
          chmod +x /usr/local/bin/nrfutil
          nrfutil install toolchain-manager

      - name: Restore NCS
        id: cache-ncs-restore
        uses: actions/cache/restore@v4
        with:
          path: /home/runner/ncs/
          key: ncs-${{ runner.os }}-${{ env.NRF_TOOLCHAIN_VERSION }}-${{ env.NRF_SDK_VERSION }}

      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Toolchain + NRF & ANT SDK
        if: steps.cache-ncs-restore.outputs.cache-hit != 'true'
        run: |
          # install toolchain
          nrfutil toolchain-manager install --ncs-version ${NRF_TOOLCHAIN_VERSION}

          # install nrf sdk
          mkdir -p /home/runner/ncs/sdks/
          cd /home/runner/ncs/sdks/
          west init -m https://github.com/nrfconnect/sdk-nrf --mr ${NRF_SDK_VERSION} ${NRF_SDK_VERSION}
          cd /home/runner/ncs/sdks/${NRF_SDK_VERSION}/
          west update

          ## install ant SDK
          # allow access
          git config --global credential.helper cache
          git ls-remote https://SKS_AIRSPY_ANT_TOKEN:${{ secrets.SKS_AIRSPY_ANT_TOKEN }}@github.com/ant-nrfconnect/sdk-ant > /dev/null
          # fetch ant SDK
          west config manifest.group-filter +ant
          west update
          pushd /home/runner/ncs/sdks/${NRF_SDK_VERSION}/ant && git apply --whitespace=fix ${{ github.workspace }}/ant_sdk_nrf52832.patch && popd
          west list ant

          # finalize sdk install
          nrfutil toolchain-manager launch -- west zephyr-export

      - name: Save NCS
        if: steps.cache-ncs-restore.outputs.cache-hit != 'true'
        id: cache-ncs-save
        uses: actions/cache/save@v4
        with:
          path: /home/runner/ncs/
          key: ncs-${{ runner.os }}-${{ env.NRF_TOOLCHAIN_VERSION }}-${{ env.NRF_SDK_VERSION }}

      - name: Build Application
        id: app-build
        working-directory: /home/runner/ncs/sdks/${{ env.NRF_SDK_VERSION }}/
        run: |
          echo "${{ secrets.MCUBOOT_SIGNING_KEY }}" > ${{ github.workspace }}/mcuboot.pem
          nrfutil toolchain-manager launch -- west build --board sks_airspy --build-dir ${{ github.workspace }}/build/ --no-sysbuild ${{ github.workspace }}

      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sks-airspy-community-firmware
          path: |
            ${{ github.workspace }}/build/zephyr/merged.hex
            ${{ github.workspace }}/build/zephyr/dfu_application.zip
